# Make all number positive
total_number_of_volumes = abs(total_number_of_volumes),
# Sort the 34 different transaction types into the three main ones
transaction_type = case_when(
# We are only interesting in print runs among the in transactions
str_detect(direction_of_transaction, regex("printing", ignore_case = T)) ~ "in",
str_detect(direction_of_transaction, regex("^in", ignore_case = T)) ~ "NA",
str_detect(direction_of_transaction, regex("^out", ignore_case = T)) ~ "out",
TRUE ~ "neutral"
),
# Calculate how many sheets were used for each transaction
sheets_used = total_number_of_volumes / number_of_volumes * sheets_estimate,
# Infer year data
year = lubridate::ymd(date) %>% lubridate::year()
) %>%
# Just focus on editions the STN manufactured themselves
filter(edition_type %in% c('STN editions', 'Livres en Société: STN joint editions', 'Commissioned STN edition')) %>%
# Sum up by year for each transaction type
group_by(transaction_type, year) %>%
summarise(sheets_used = sum(sheets_used, na.rm = T)) %>%
ggplot(aes(x = year, y = sheets_used, colour = transaction_type)) +
geom_line()
transactions %>%
mutate(
# Make all number positive
total_number_of_volumes = abs(total_number_of_volumes),
# Sort the 34 different transaction types into the three main ones
transaction_type = case_when(
# We are only interesting in print runs among the in transactions
str_detect(direction_of_transaction, regex("printing", ignore_case = T)) ~ "in",
str_detect(direction_of_transaction, regex("^in", ignore_case = T)) ~ "NA",
str_detect(direction_of_transaction, regex("^out", ignore_case = T)) ~ "out",
TRUE ~ "neutral"
),
# Calculate how many sheets were used for each transaction
sheets_used = total_number_of_volumes / number_of_volumes * sheets_estimate,
# Infer year data
year = lubridate::ymd(date) %>% lubridate::year()
) %>%
# Just focus on editions the STN manufactured themselves
filter(
transaction_type != "NA",
edition_type %in% c('STN editions', 'Livres en Société: STN joint editions', 'Commissioned STN edition')
) %>%
# Sum up by year for each transaction type
group_by(transaction_type, year) %>%
summarise(sheets_used = sum(sheets_used, na.rm = T)) %>%
ggplot(aes(x = year, y = sheets_used, colour = transaction_type)) +
geom_line()
transactions %>%
mutate(
# Make all number positive
total_number_of_volumes = abs(total_number_of_volumes),
# Sort the 34 different transaction types into the three main ones
transaction_type = case_when(
# We are only interesting in print runs among the in transactions
str_detect(direction_of_transaction, regex("printing", ignore_case = T)) ~ "in",
str_detect(direction_of_transaction, regex("^in", ignore_case = T)) ~ "NA",
str_detect(direction_of_transaction, regex("^out", ignore_case = T)) ~ "out",
TRUE ~ "neutral"
),
# Calculate how many sheets were used for each transaction
sheets_used = total_number_of_volumes / number_of_volumes * sheets_estimate,
# Infer year data
year = lubridate::ymd(date) %>% lubridate::year()
) %>%
# Just focus on editions the STN manufactured themselves
filter(
transaction_type %in% c("in","out"),
edition_type %in% c('STN editions', 'Livres en Société: STN joint editions', 'Commissioned STN edition')
) %>%
# Sum up by year for each transaction type
group_by(transaction_type, year) %>%
summarise(sheets_used = sum(sheets_used, na.rm = T)) %>%
ggplot(aes(x = year, y = sheets_used, colour = transaction_type)) +
geom_line()
transactions %>%
mutate(
# Make all number positive
total_number_of_volumes = abs(total_number_of_volumes),
# Sort the 34 different transaction types into the three main ones
transaction_type = case_when(
# We are only interesting in print runs among the in transactions
str_detect(direction_of_transaction, regex("printing", ignore_case = T)) ~ "in",
str_detect(direction_of_transaction, regex("^in", ignore_case = T)) ~ "NA",
str_detect(direction_of_transaction, regex("^out", ignore_case = T)) ~ "out",
TRUE ~ "neutral"
),
# Calculate how many sheets were used for each transaction
sheets_used = total_number_of_volumes / number_of_volumes * sheets_estimate,
# Infer year data
year = lubridate::ymd(date) %>% lubridate::year()
) %>%
# Just focus on editions the STN manufactured themselves
filter(
transaction_type %in% c("in","out"),
edition_type %in% c('STN editions', 'Livres en Société: STN joint editions', 'Commissioned STN edition')
) %>%
# Sum up by year for each transaction type
group_by(transaction_type, year) %>%
summarise(sheets_used = sum(sheets_used, na.rm = T)) %>%
ggplot(aes(x = year, y = sheets_used, colour = transaction_type)) +
geom_line() +
theme_bw() +
scale_colour_discrete(labels = c("in" = "Printing", "out" = "Out transaction")) +
labs(
title = "Print runs and out-transactions compared",
colour = "Transaction\ntype",
y = "Sheets used (estimate)",
x = "Year"
)
transactions %>%
mutate(
# Make all number positive
total_number_of_volumes = abs(total_number_of_volumes),
# Sort the 34 different transaction types into the three main ones
transaction_type = case_when(
# We are only interesting in print runs among the in transactions
str_detect(direction_of_transaction, regex("printing", ignore_case = T)) ~ "in",
str_detect(direction_of_transaction, regex("^in", ignore_case = T)) ~ "NA",
str_detect(direction_of_transaction, regex("^out", ignore_case = T)) ~ "out",
TRUE ~ "neutral"
),
# Calculate how many sheets were used for each transaction
sheets_used = total_number_of_volumes / number_of_volumes * sheets_estimate,
# Infer year data
year = lubridate::ymd(date) %>% lubridate::year()
) %>%
# Just focus on editions the STN manufactured themselves
filter(
transaction_type %in% c("in","out"),
edition_type %in% c('STN editions', 'Livres en Société: STN joint editions', 'Commissioned STN edition')
) %>%
# Sum up by year for each transaction type
group_by(transaction_type, year) %>%
summarise(sheets_used = sum(sheets_used, na.rm = T)) %>%
ggplot(aes(x = year, y = sheets_used, colour = transaction_type)) +
geom_line() +
theme_bw() +
scale_colour_discrete(labels = c("in" = "Printing", "out" = "Out transaction")) +
scale_y_continuous(labels = scales::comma_format()) =
labs(
title = "Print runs and out-transactions compared",
colour = "Transaction\ntype",
y = "Sheets used (estimate)",
x = "Year"
)
transactions %>%
mutate(
# Make all number positive
total_number_of_volumes = abs(total_number_of_volumes),
# Sort the 34 different transaction types into the three main ones
transaction_type = case_when(
# We are only interesting in print runs among the in transactions
str_detect(direction_of_transaction, regex("printing", ignore_case = T)) ~ "in",
str_detect(direction_of_transaction, regex("^in", ignore_case = T)) ~ "NA",
str_detect(direction_of_transaction, regex("^out", ignore_case = T)) ~ "out",
TRUE ~ "neutral"
),
# Calculate how many sheets were used for each transaction
sheets_used = total_number_of_volumes / number_of_volumes * sheets_estimate,
# Infer year data
year = lubridate::ymd(date) %>% lubridate::year()
) %>%
# Just focus on editions the STN manufactured themselves
filter(
transaction_type %in% c("in","out"),
edition_type %in% c('STN editions', 'Livres en Société: STN joint editions', 'Commissioned STN edition')
) %>%
# Sum up by year for each transaction type
group_by(transaction_type, year) %>%
summarise(sheets_used = sum(sheets_used, na.rm = T)) %>%
ggplot(aes(x = year, y = sheets_used, colour = transaction_type)) +
geom_line() +
theme_bw() +
scale_colour_discrete(labels = c("in" = "Printing", "out" = "Out transaction")) +
scale_y_continuous(labels = scales::comma_format()) +
labs(
title = "Print runs and out-transactions compared",
colour = "Transaction\ntype",
y = "Sheets used (estimate)",
x = "Year"
)
warnings()
transactions %>%
mutate(
# Make all number positive
total_number_of_volumes = abs(total_number_of_volumes),
# Sort the 34 different transaction types into the three main ones
transaction_type = case_when(
# We are only interesting in print runs among the in transactions
str_detect(direction_of_transaction, regex("printing", ignore_case = T)) ~ "in",
str_detect(direction_of_transaction, regex("^in", ignore_case = T)) ~ "NA",
str_detect(direction_of_transaction, regex("^out", ignore_case = T)) ~ "out",
TRUE ~ "neutral"
),
# Calculate how many sheets were used for each transaction
sheets_used = total_number_of_volumes / number_of_volumes * sheets_estimate,
# Infer year data
year = lubridate::ymd(date) %>% lubridate::year()
) %>%
# Just focus on editions the STN manufactured themselves
filter(
transaction_type %in% c("in","out"),
edition_type %in% c('STN editions', 'Livres en Société: STN joint editions', 'Commissioned STN edition')
) %>%
# Sum up by year for each transaction type
group_by(transaction_type, year) %>%
summarise(sheets_used = sum(sheets_used, na.rm = T))
# ggplot(aes(x = year, y = sheets_used, colour = transaction_type)) +
# geom_line() +
# theme_bw() +
# scale_colour_discrete(labels = c("in" = "Printing", "out" = "Out transaction")) +
# scale_y_continuous(labels = scales::comma_format()) +
# labs(
#   title = "Print runs and out-transactions compared",
#   colour = "Transaction\ntype",
#   y = "Sheets used (estimate)",
#   x = "Year"
# )
transactions %>%
mutate(
# Make all number positive
total_number_of_volumes = abs(total_number_of_volumes),
# Sort the 34 different transaction types into the three main ones
transaction_type = case_when(
# We are only interesting in print runs among the in transactions
str_detect(direction_of_transaction, regex("printing", ignore_case = T)) ~ "in",
str_detect(direction_of_transaction, regex("^in", ignore_case = T)) ~ "NA",
str_detect(direction_of_transaction, regex("^out", ignore_case = T)) ~ "out",
TRUE ~ "neutral"
),
# Calculate how many sheets were used for each transaction
sheets_used = total_number_of_volumes / number_of_volumes * sheets_estimate,
# Infer year data
year = lubridate::ymd(date) %>% lubridate::year()
) %>%
# Just focus on editions the STN manufactured themselves
filter(
transaction_type %in% c("in","out"),
edition_type %in% c('STN editions', 'Livres en Société: STN joint editions', 'Commissioned STN edition')
) %>%
# Sum up by year for each transaction type
group_by(transaction_type, year) %>%
summarise(sheets_used = sum(sheets_used, na.rm = T)) %>%
drop_na()
# ggplot(aes(x = year, y = sheets_used, colour = transaction_type)) +
# geom_line() +
# theme_bw() +
# scale_colour_discrete(labels = c("in" = "Printing", "out" = "Out transaction")) +
# scale_y_continuous(labels = scales::comma_format()) +
# labs(
#   title = "Print runs and out-transactions compared",
#   colour = "Transaction\ntype",
#   y = "Sheets used (estimate)",
#   x = "Year"
# )
transactions %>%
mutate(
# Make all number positive
total_number_of_volumes = abs(total_number_of_volumes),
# Sort the 34 different transaction types into the three main ones
transaction_type = case_when(
# We are only interesting in print runs among the in transactions
str_detect(direction_of_transaction, regex("printing", ignore_case = T)) ~ "in",
str_detect(direction_of_transaction, regex("^in", ignore_case = T)) ~ "NA",
str_detect(direction_of_transaction, regex("^out", ignore_case = T)) ~ "out",
TRUE ~ "neutral"
),
# Calculate how many sheets were used for each transaction
sheets_used = total_number_of_volumes / number_of_volumes * sheets_estimate,
# Infer year data
year = lubridate::ymd(date) %>% lubridate::year()
) %>%
# Just focus on editions the STN manufactured themselves
filter(
transaction_type %in% c("in","out"),
edition_type %in% c('STN editions', 'Livres en Société: STN joint editions', 'Commissioned STN edition')
) %>%
# Sum up by year for each transaction type
group_by(transaction_type, year) %>%
summarise(sheets_used = sum(sheets_used, na.rm = T)) %>%
drop_na() %>%
ungroup()
# ggplot(aes(x = year, y = sheets_used, colour = transaction_type)) +
# geom_line() +
# theme_bw() +
# scale_colour_discrete(labels = c("in" = "Printing", "out" = "Out transaction")) +
# scale_y_continuous(labels = scales::comma_format()) +
# labs(
#   title = "Print runs and out-transactions compared",
#   colour = "Transaction\ntype",
#   y = "Sheets used (estimate)",
#   x = "Year"
# )
transactions %>%
mutate(
# Make all number positive
total_number_of_volumes = abs(total_number_of_volumes),
# Sort the 34 different transaction types into the three main ones
transaction_type = case_when(
# We are only interesting in print runs among the in transactions
str_detect(direction_of_transaction, regex("printing", ignore_case = T)) ~ "in",
str_detect(direction_of_transaction, regex("^in", ignore_case = T)) ~ "NA",
str_detect(direction_of_transaction, regex("^out", ignore_case = T)) ~ "out",
TRUE ~ "neutral"
),
# Calculate how many sheets were used for each transaction
sheets_used = total_number_of_volumes / number_of_volumes * sheets_estimate,
# Infer year data
year = lubridate::ymd(date) %>% lubridate::year()
) %>%
# Just focus on editions the STN manufactured themselves
filter(
transaction_type %in% c("in","out"),
edition_type %in% c('STN editions', 'Livres en Société: STN joint editions', 'Commissioned STN edition')
) %>%
# Sum up by year for each transaction type
group_by(transaction_type, year) %>%
summarise(sheets_used = sum(sheets_used, na.rm = T)) %>%
drop_na() %>%
ungroup() %>%
ggplot(aes(x = year, y = sheets_used, colour = transaction_type)) +
geom_line() +
theme_bw() +
scale_colour_discrete(labels = c("in" = "Printing", "out" = "Out transaction")) +
scale_y_continuous(labels = scales::comma_format()) +
labs(
title = "Print runs and out-transactions compared",
colour = "Transaction\ntype",
y = "Sheets used (estimate)",
x = "Year"
)
transactions %>%
mutate(
# Make all number positive
total_number_of_volumes = abs(total_number_of_volumes),
# Sort the 34 different transaction types into the three main ones
transaction_type = case_when(
# We are only interesting in print runs among the in transactions
str_detect(direction_of_transaction, regex("printing", ignore_case = T)) ~ "in",
str_detect(direction_of_transaction, regex("^in", ignore_case = T)) ~ "NA",
str_detect(direction_of_transaction, regex("^out", ignore_case = T)) ~ "out",
TRUE ~ "neutral"
),
# Calculate how many sheets were used for each transaction
sheets_used = total_number_of_volumes / number_of_volumes * sheets_estimate,
# Infer year data
year = lubridate::ymd(date) %>% lubridate::year()
) %>%
# Just focus on editions the STN manufactured themselves
filter(
transaction_type %in% c("in","out"),
edition_type %in% c('STN editions', 'Livres en Société: STN joint editions', 'Commissioned STN edition')
) %>%
# Sum up by year for each transaction type
group_by(transaction_type, year) %>%
summarise(sheets_used = sum(sheets_used, na.rm = T)) %>%
drop_na() %>%
ungroup() %>%
ggplot(aes(x = year, y = sheets_used, colour = transaction_type)) +
geom_line() +
theme_minimal() +
scale_colour_discrete(labels = c("in" = "Printing", "out" = "Out transaction")) +
scale_y_continuous(labels = scales::comma_format()) +
labs(
title = "Print runs and out-transactions compared",
colour = "Transaction\ntype",
y = "Sheets used (estimate)",
x = "Year"
)
transactions %>%
mutate(
# Make all number positive
total_number_of_volumes = abs(total_number_of_volumes),
# Sort the 34 different transaction types into the three main ones
transaction_type = case_when(
# We are only interesting in print runs among the in transactions
str_detect(direction_of_transaction, regex("printing", ignore_case = T)) ~ "in",
str_detect(direction_of_transaction, regex("^in", ignore_case = T)) ~ "NA",
str_detect(direction_of_transaction, regex("^out", ignore_case = T)) ~ "out",
TRUE ~ "neutral"
),
# Calculate how many sheets were used for each transaction
sheets_used = total_number_of_volumes / number_of_volumes * sheets_estimate,
# Infer year data
year = lubridate::ymd(date) %>% lubridate::year()
) %>%
# Just focus on editions the STN manufactured themselves
filter(
transaction_type %in% c("in","out"),
edition_type %in% c('STN editions', 'Livres en Société: STN joint editions', 'Commissioned STN edition')
) %>%
# Sum up by year for each transaction type
group_by(transaction_type, year) %>%
summarise(sheets_used = sum(sheets_used, na.rm = T)) %>%
drop_na() %>%
ungroup() %>%
ggplot(aes(x = year, y = sheets_used, colour = transaction_type)) +
geom_line() +
theme_minimal() +
scale_colour_discrete(labels = c("in" = "Printing", "out" = "Out transaction")) +
scale_y_continuous(labels = scales::comma_format()) +
labs(
title = "Print runs and out-transactions compared",
colour = "Transaction\ntype",
y = "Sheets used (estimate)",
x = "Year"
)
warnings()
update.packages()
rm(list = ls())
update.packages()
install.packages('colorspace')
install.packages('git2r')
transactions %>%
mutate(
# Make all number positive
total_number_of_volumes = abs(total_number_of_volumes),
# Sort the 34 different transaction types into the three main ones
transaction_type = case_when(
# We are only interesting in print runs among the in transactions
str_detect(direction_of_transaction, regex("printing", ignore_case = T)) ~ "in",
str_detect(direction_of_transaction, regex("^in", ignore_case = T)) ~ "NA",
str_detect(direction_of_transaction, regex("^out", ignore_case = T)) ~ "out",
TRUE ~ "neutral"
),
# Calculate how many sheets were used for each transaction
sheets_used = total_number_of_volumes / number_of_volumes * sheets_estimate,
# Infer year data
year = lubridate::ymd(date) %>% lubridate::year()
) %>%
# Just focus on editions the STN manufactured themselves
filter(
transaction_type %in% c("in","out"),
edition_type %in% c('STN editions', 'Livres en Société: STN joint editions', 'Commissioned STN edition')
) %>%
# Sum up by year for each transaction type
group_by(transaction_type, year) %>%
summarise(sheets_used = sum(sheets_used, na.rm = T)) %>%
drop_na() %>%
ungroup() %>%
ggplot(aes(x = year, y = sheets_used, colour = transaction_type)) +
theme_minimal() +
scale_colour_discrete(labels = c("in" = "Printing", "out" = "Out transaction")) +
scale_y_continuous(labels = scales::comma_format()) +
labs(
title = "Print runs and out-transactions compared",
colour = "Transaction\ntype",
y = "Sheets used (estimate)",
x = "Year"
) +
geom_line()
install.packages('tidyverse')
install.packages('lazyeval')
transactions %>%
mutate(
# Make all number positive
total_number_of_volumes = abs(total_number_of_volumes),
# Sort the 34 different transaction types into the three main ones
transaction_type = case_when(
# We are only interesting in print runs among the in transactions
str_detect(direction_of_transaction, regex("printing", ignore_case = T)) ~ "in",
str_detect(direction_of_transaction, regex("^in", ignore_case = T)) ~ "NA",
str_detect(direction_of_transaction, regex("^out", ignore_case = T)) ~ "out",
TRUE ~ "neutral"
),
# Calculate how many sheets were used for each transaction
sheets_used = total_number_of_volumes / number_of_volumes * sheets_estimate,
# Infer year data
year = lubridate::ymd(date) %>% lubridate::year()
) %>%
# Just focus on editions the STN manufactured themselves
filter(
transaction_type %in% c("in","out"),
edition_type %in% c('STN editions', 'Livres en Société: STN joint editions', 'Commissioned STN edition')
) %>%
# Sum up by year for each transaction type
group_by(transaction_type, year) %>%
summarise(sheets_used = sum(sheets_used, na.rm = T)) %>%
drop_na() %>%
ungroup() %>%
ggplot(aes(x = year, y = sheets_used, colour = transaction_type)) +
theme_minimal() +
scale_colour_discrete(labels = c("in" = "Printing", "out" = "Out transaction")) +
scale_y_continuous(labels = scales::comma_format()) +
labs(
title = "Print runs and out-transactions compared",
colour = "Transaction\ntype",
y = "Sheets used (estimate)",
x = "Year"
) +
geom_line()
library(kableExtra)
library(kableExtra)
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
# Connect to the database and load functions and packages
source('init.R')
# Import key data
orders <- fetch_table(stn, "orders") # Each transaction is part of an overarching 'order'
editions <- fetch_table(stn, "books") %>%
# Estimate the sheets using the 'edition' and 'pages' info
mutate(
book_sheets = str_remove(book_sheets, "\\D") %>% as.numeric(),
total_pages = sum_pages(pages),
leaves = str_replace(edition, "[Ff]olio", "2") %>% str_remove("\\D") %>% as.numeric(),
sheets_estimate = calculate_sheets(total_pages, leaves)
) # Each transaction concerns a particular edition
transactions <- fetch_table(stn, "transactions") %>% # Load transaction data
left_join(orders, by = "order_code") %>% # Join to order information (e.g. to get dates)
left_join(editions, by = "book_code") # Joine to edition information (e.g. to get format details)
rm(list = ls())
